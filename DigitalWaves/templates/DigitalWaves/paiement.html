{% extends "DigitalWaves/base.html" %}
{% load static %}
{% load custom_filters %}
{% block content %}

<div class="container">
    
    
    <h3>Produits dans le panier :</h3>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Produit</th>
                <th>Quantité</th>
                <th>Prix unitaire</th>
                <th>Sous-total</th>
            </tr>
        </thead>
        <tbody>
            {% for produit in produits_panier %}
            <tr>
                <td>{{ produit.produit.nom }}</td>
                <td>{{ produit.quantite }}</td>
                <td>€{{ produit.produit.prix }}</td>
                <td>€{{ produit.quantite|multiply:produit.produit.prix }}</td>
            </tr>
            {% endfor %}
        </tbody>
        <tfoot>
            <tr>
                <th colspan="3">Total :</th>
                <td>€{{ total_panier }}</td>
            </tr>
        </tfoot>
    </table>
    <h2>Paiement</h2>
    <form id="paiement-form" method="post">
        {% csrf_token %}
        {{ form.as_p }}
        <a href="commande_complete.html"></a><button type="submit" class="btn btn-success">Commander</button>
    </form>
    <div id="paypal-button-container"></div>
</div>
<br>
<br>
<br>
<br>
<br>
{% endblock %}

{% block js %}

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://www.paypal.com/sdk/js?client-id=AXtmm-0AiQWFXZTW54XoRtdUHJt2G_75702h6_PLB9G77rL7picfI-Y2eeRZ6ivtAmavOq7mhON9V68L&currency=EUR"></script>
<script src="{% static 'js/main.js' %}"></script>
<script>
    paypal.Buttons({
        createOrder: function(data, actions) {
            return actions.order.create({
                purchase_units: [{
                    amount: {
                        value: '{{ total_panier }}'
                    }
                }]
            });
        },
        onApprove: function(data, actions) {
            return actions.order.capture().then(function(details) {
                $.ajax({
                    url: "{% url 'process_paypal_payment' %}",
                    method: 'POST',
                    data: {
                        orderID: data.orderID,
                        csrfmiddlewaretoken: '{{ csrf_token }}'
                    },
                    success: function(response) {
                        if (response.status === 'success') {
                            window.location.href = "{% url 'payment_success' %}";
                        } else {
                            alert('Il y a eu un problème avec le paiement. Veuillez réessayer.');
                        }
                    },
                    error: function(error) {
                        alert('Erreur lors du traitement du paiement.');
                    }
                });
            });
        }
    }).render('#paypal-button-container');
</script>
{% endblock %}
